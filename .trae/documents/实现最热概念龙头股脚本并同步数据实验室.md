## 需求拆解
- 用 Tushare/Akshare 抓取“当前最热”的 3–5 个概念板块
- 在每个板块内筛出前 3 名“龙头股”
- 将该功能以“数据实验室”脚本的形式写入 DB 的 `research_scripts` 表（即页面「数据实验室」）

## 数据源与接口选择（优先 Tushare）
- **板块热度**：优先用 Tushare 的同花顺概念板块资金流向接口 `moneyflow_cnt_ths`（5000 积分即可）来定义“最热”。文档：
  - [04_板块资金流向（THS.md）](file:///Users/huangchuanjian/workspace/my_projects/ai_watch_stock/docs/tushare%20%E6%96%87%E6%A1%A3/01_%E8%82%A1%E7%A5%A8%E6%95%B0%E6%8D%AE/07_%E8%B5%84%E9%87%91%E6%B5%81%E5%90%91%E6%95%B0%E6%8D%AE/04_%E6%9D%BF%E5%9D%97%E8%B5%84%E9%87%91%E6%B5%81%E5%90%91%EF%BC%88THS.md)
- **板块成分股**：用 `ths_member` 拉取概念板块成分。文档：
  - [12_同花顺行业概念成分.md](file:///Users/huangchuanjian/workspace/my_projects/ai_watch_stock/docs/tushare%20%E6%96%87%E6%A1%A3/01_%E8%82%A1%E7%A5%A8%E6%95%B0%E6%8D%AE/08_%E6%89%93%E6%9D%BF%E4%B8%93%E9%A2%98%E6%95%B0%E6%8D%AE/12_%E5%90%8C%E8%8A%B1%E9%A1%BA%E8%A1%8C%E4%B8%9A%E6%A6%82%E5%BF%B5%E6%88%90%E5%88%86.md)
- **龙头股排序数据**：用 `pro.daily(trade_date=...)` 一次性拉取全市场当日行情（含 `pct_chg/amount`），再按板块成分过滤并排序，避免循环接口。
- **兜底方案（可选）**：若 `moneyflow_cnt_ths` 权限/数据缺失，降级使用 `ths_hot(market='概念板块')` 或 SW 行业 `sw_daily`（但仍以概念板块优先）。文档：
  - [16_同花顺App热榜数.md](file:///Users/huangchuanjian/workspace/my_projects/ai_watch_stock/docs/tushare%20%E6%96%87%E6%A1%A3/01_%E8%82%A1%E7%A5%A8%E6%95%B0%E6%8D%AE/08_%E6%89%93%E6%9D%BF%E4%B8%93%E9%A2%98%E6%95%B0%E6%8D%AE/16_%E5%90%8C%E8%8A%B1%E9%A1%BAApp%E7%83%AD%E6%A6%9C%E6%95%B0.md)

## “最热”与“龙头”定义（可解释、可复现）
- **最热板块（3–5 个）**：在 `moneyflow_cnt_ths(trade_date=最新交易日)` 结果中，计算热度分：
  - `heat_score = 0.7 * rank(net_amount desc) + 0.3 * rank(pct_change desc)`
  - 取 `heat_score` 最小的 Top N（默认 N=5，可在脚本顶部配置成 3–5）
- **板块龙头股（每板块 3 个）**：
  - 先取该板块 `ths_member(ts_code=板块代码)` 的成分股列表
  - 用当日 `pro.daily(trade_date=...)` 过滤到这些成分股
  - `leader_score = 0.6 * rank(pct_chg desc) + 0.4 * rank(amount desc)`，取 Top3

## 落库与展示方式（“数据实验室”表）
- “数据实验室”对应 DB 表 `research_scripts`，通过后端 ORM `ResearchScript` 管理：
  - [models.py](file:///Users/huangchuanjian/workspace/my_projects/ai_watch_stock/backend/models.py#L156-L169)
- 运行环境已为脚本注入 `pro/ts/ak/pd/today/now`：
  - [research_service.py](file:///Users/huangchuanjian/workspace/my_projects/ai_watch_stock/backend/services/research_service.py#L12-L71)
- 同步到 DB 的方式：新增一个脚本注入器（与现有 `scripts/inject_kdj_chain.py` 同模式），upsert 写入 `research_scripts`。

## 代码实现步骤（用户确认后执行）
1. 新增一个“数据实验室脚本”内容（纯 Python，输出 `df`）：
   - 标题建议：`最热概念板块龙头股（THS资金流向）`
   - 逻辑：取最新交易日 → 拉 `moneyflow_cnt_ths` → 选 Top5 概念板块 → 拉每个板块成分 → 用 `daily` 排 Top3 → 组装结果 DataFrame
   - 失败处理：`pro is None`/权限不足/接口返回空时给出清晰 `print()` 日志与空表
2. 新增注入脚本（例如 `scripts/inject_hot_concept_leaders_lab.py`）：
   - 连接 `SessionLocal`
   - `session.query(ResearchScript).filter_by(title=...).first()`
   - 存在则更新 `script_content/description/is_pinned`，不存在则创建
3. 执行注入脚本一次，将记录写入 `backend/stock_watch.db`（确保不新建 DB，仅使用现有库文件；项目已强制校验存在）。
4. 本地验证：
   - 用 Python 直接调用 `execute_research_script()` 对脚本做语法与运行验证（至少验证能返回 `result/df`、日志输出正常）
   - 若网络/权限允许，再实跑一次拉取真实数据，确认返回 15 行左右（5 板块 × 3 龙头）
   - 打开前端「数据实验室」确认脚本已出现在列表中，可点击运行看到表格结果

## 交付物
- 一个新的“数据实验室”脚本记录（写入 `research_scripts`）
- 一个可重复执行的注入脚本（用于后续更新脚本逻辑）
- 结果表字段示例：`trade_date, board_ts_code, board_name, board_rank, board_heat, net_amount, pct_change, leader_rank, stock_ts_code, stock_name, pct_chg, amount`
