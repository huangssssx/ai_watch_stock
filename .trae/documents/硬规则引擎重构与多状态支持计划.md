# 硬规则引擎重构与多状态支持计划

## 1. 问题分析
当前系统的硬规则（Hard Rules）引擎存在以下局限性，导致无法满足复杂的交易策略需求：
1.  **状态二元化**：脚本仅返回 `triggered` (True/False)，无法区分买入、卖出或观望。
2.  **默认行为僵化**：在 `script_only`（仅脚本）模式下，一旦 `triggered=True`，系统强制将信号判定为 `BUY`，导致卖出策略无法实施。
3.  **扩充性不足**：缺乏明确的信号强度或方向字段。

## 2. 解决方案设计
我们将通过引入 `signal` 变量来扩展脚本与系统的交互协议，同时保留对旧脚本的 `triggered` 兼容支持。

### 新交互协议
脚本执行后，除了检查 `triggered`，系统将优先检查 `signal` 变量。
*   **`signal` (str)**: 允许的值包括 `"BUY"`, `"SELL"`, `"STRONG_BUY"`, `"STRONG_SELL"`, `"WAIT"`。
*   **兼容逻辑**: 如果脚本未定义 `signal` 但 `triggered=True`，系统将默认视为 `"BUY"`。

## 3. 实施步骤

### 第一步：改造执行引擎 (`monitor_service.py`)
修改 `_execute_rule_script` 和 `process_stock` 函数：
1.  **捕获信号**：在 `exec` 执行后的 `local_scope` 中尝试获取 `signal` 变量。
2.  **逻辑映射**：
    *   在 `script_only` 模式下，直接使用脚本返回的 `signal` 填充分析结果（Analysis JSON）。
    *   移除硬编码的 `"signal": "BUY"`。

### 第二步：更新测试接口 (`routers/rules.py`)
修改 `/rules/{rule_id}/test` 接口：
1.  在测试结果中包含 `signal` 字段，以便用户在调试时能看到策略输出的信号方向。

### 第三步：升级策略脚本 (`鬣狗策略.py`)
以用户提供的 `鬣狗策略.py` 为例，演示如何适配新标准：
1.  初始化 `signal = "WAIT"`。
2.  在触发买入条件时，设置 `signal = "BUY"`。
3.  (可选) 增加卖出逻辑，设置 `signal = "SELL"`。

## 4. 验证计划
1.  **单元测试**：创建一个返回 `signal="SELL"` 的临时脚本。
2.  **接口测试**：调用 `/rules/.../test` 确认返回的 JSON 中包含正确的信号。
3.  **逻辑核查**：检查 `monitor_service.py` 代码，确保在 `signal="SELL"` 时，最终生成的 Log 和 Alert 均为卖出方向。
