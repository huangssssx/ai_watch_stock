# 数据库脚本“手/股”单位问题排查与修复计划

经过对数据库中 **选股 (Selection)**、**规则 (Rule)**、**数据实验室 (Research)**、**指标 (Indicator)** 四类脚本的全面排查，结果如下：

## 1. 排查结果汇总

| 类别 | 脚本名称 | 状态 | 风险描述 |
| :--- | :--- | :--- | :--- |
| **指标** | **今日分时 VWAP/日内强弱** | 🔴 **高风险** | 代码硬编码假设 `成交量` 单位为“手” (`vol * 100`)。若接口返回“股”，VWAP 将错误地变为股价的 1/100。 |
| **指标** | **5 分钟数据（分时历史）** | 🟠 **中风险** | 直接输出 `成交量` 列，未进行单位换算或标记。用户无法直观判断是“手”还是“股”。 |
| **选股** | 山谷狙击选股 | 🟢 **安全** | 脚本注释明确标注已在 v8.6 版本修复 VWAP 单位问题，采用了自适应逻辑。 |
| **规则** | 触底反弹监控 | 🟢 **安全** | 逻辑主要基于 `成交量` 的自身对比（如 `今日量 > 昨日量`），单位不影响比值结果。 |

## 2. 问题详情

### (1) [指标] 今日分时 VWAP/日内强弱
**当前代码：**
```python
if "成交量" in df_min.columns:
    total_vol_hands = float(pd.to_numeric(df_min["成交量"], errors="coerce").fillna(0).sum())
# ⚠️ 风险：直接假设单位是手，乘以 100
total_shares = max(total_vol_hands * 100.0, 1.0)
vwap = float(total_amount / total_shares)
```
**隐患：** AKShare 接口（`stock_zh_a_hist_min_em`）虽然通常返回“手”，但一旦变更为“股”，计算出的 VWAP 会严重失真。

### (2) [指标] 5 分钟数据（分时历史）
**当前代码：**
```python
df = df[["时间", "开盘", "最高", "最低", "收盘", "成交量", "MA5", "MA20"]]
```
**隐患：** 数据展示层面未对单位进行标准化，可能导致歧义。

## 3. 修复计划

我建议执行以下修复操作：

### 步骤 1：修复 `今日分时 VWAP` (优先级：高)
- **方案**：引入 **Ratio Check** 自适应逻辑。
- **逻辑**：
  1. 计算 `Raw_VWAP = 总成交额 / 总成交量`。
  2. 若 `Raw_VWAP` 接近股价（0.8-1.2倍），则单位为“股”。
  3. 若 `Raw_VWAP` 约为股价的 100 倍（80-120倍），则单位为“手”，需 `* 100`。
  4. 其他情况默认为“手”并记录警告。

### 步骤 2：优化 `5 分钟数据` (优先级：中)
- **方案**：明确列名或统一单位。
- **逻辑**：将 `成交量` 列重命名为 `成交量(手)`（如果确认为手），或统一转换为“股”并标注。鉴于分时数据通常量大，建议保持原值但修改列名为 `成交量(原始单位)` 或根据 Ratio Check 动态标注。

### 步骤 3：验证
- 运行修复后的脚本，对比某只股票（如 `600519` 茅台）的计算结果与行情软件是否一致。

请确认是否执行上述修复计划？