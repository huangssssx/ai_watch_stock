## 目标
- 修复脚本当前的运行错误与核心逻辑错误，并把判定严格对齐到你给的策略参数。
- 支持“只跑3只股票”的验证模式，并按阶段输出中间结果，逐项核对：流程、接口参数、接口返回、数据清晰度、处理结果、阶段预期一致。

## 现状主要问题（将被修复）
- 运行级错误：
  - analyze_stock 返回里引用未定义变量 key_level（会导致异常被吞、结果恒为空）。
  - main 里引用未定义变量 latest_date（只要有结果就会崩）。
- 策略级错误：
  - df 降序 + “突破后窗口”遍历方向写反，导致把突破前数据当成突破后站稳。
  - 关键位计算可能引入“看未来”（突破后高点被当关键位）。

## 改造方案（策略逻辑对齐）
### 1) 时间方向与事件窗口（保证语义正确）
- 在 check_breakout_and_stable 内部统一把数据按交易日升序（旧→新）处理。
- 突破日定义：收盘价 ≥ key_level * 1.015，且突破日 vol ≥ 突破日前20日均量 * 1.5。
- 站稳3日：以突破日开始连续3个交易日窗口（D0/D1/D2）：
  - 3天都满足 close ≥ key_level * 0.99；
  - 且最多 1 天允许 close < key_level（但仍 ≥ key_level*0.99），其余天需 ≥ key_level。
- 站稳期不快速缩量：站稳窗口内任意一天 vol ≥ 突破日前20日均量 * 0.5。

### 2) 关键位去未来数据
- 对每个“候选突破日”，关键位只用“突破日前的历史数据切片（最多回看 90 天）”计算，避免把突破后高点当作关键位。
- 关键位集合保持你列的四类（箱体上沿/前高60/90/MA60/MA120/颈线位），满足任意一个即可触发。

### 3) 输出字段与文案一致
- analyze_stock 返回的 key_level 改为“本次命中的关键位数值（突破关键位）”，reason 同步使用该值。
- main 补齐 latest_date = trading_dates[0]，用于 daily_basic/moneyflow_dc 与输出文件名。
- 控制台“筛选条件”第5条改为“结果附加字段：资金净流入”（不作为硬过滤；你的策略描述里不是必选）。

## “跑三个股票”分阶段验证设计（你要求的 6 项）
### A) 新增“仅分析指定股票”模式
- 允许在脚本顶部/命令行参数传入 3 个 ts_code（默认给 3 个代表性标的，若你有固定三只也可以直接替换）：
  - 000001.SZ（大盘银行）
  - 600519.SH（高价白马）
  - 300750.SZ（创业板大市值）
- 执行时只跑这 3 只，不再跑全市场。

### B) 分阶段日志（每只股票都会打印同样的阶段块）
对每只股票，输出 6 个阶段，并在每阶段做“预期对照”。
1. 流程正确：打印阶段编号与耗时；确保阶段顺序固定：交易日→日线→关键位→突破候选→站稳验证→汇总。
2. 接口请求参数正确：
   - 打印 pro.daily 的 ts_code/start_date/end_date。
   - 打印 pro.trade_cal 的 exchange/start/end。
   - 打印 pro.daily_basic 的 ts_code/trade_date。
   - 打印 pro.moneyflow_dc 的 ts_code(批次)/trade_date。
   （只打印参数，不打印任何 token/敏感信息。）
3. 接口返回值正确：
   - 对 daily：检查必备列 trade_date/open/high/low/close/vol 是否齐全；打印行数、日期范围（最早/最晚）。
   - 对 daily_basic/moneyflow：检查返回是否为空、字段是否存在（circ_mv/net_amount）。
4. 数据清晰正确：
   - 打印 daily 的最新3行与最旧3行（只打印关键列）以验证排序、是否有重复日期。
   - 对 vol/close 做数值化清洗后打印 NaN 数量与异常值（<=0）的数量。
5. 数据处理结果正确：
   - 打印计算出的关键位列表（名称+数值）。
   - 打印“候选突破日列表”（日期/close/vol/volume_ratio/对应关键位）。
   - 打印最终命中的 breakout_date、key_level、3日窗口每一天 close/vol 与是否触发“回踩/缩量”规则。
6. 分阶段结果与预期一致：
   - 每阶段打印一行“PASS/FAIL + 失败原因”，例如：
     - FAIL：daily 缺列/为空
     - FAIL：无任何关键位
     - FAIL：存在突破但站稳窗口不满足（具体哪天回踩>1%或缩量>50%）
     - PASS：命中（并给出入选原因短句）

## 验证结束后的产物
- 控制台：三只股票各阶段日志 + PASS/FAIL。
- CSV：仍输出结果表（若 3 只里有命中则保存），字段确保可读且无未定义变量。

## 我将如何执行验证（在你确认计划后）
- 修改脚本后，直接以“指定三只股票模式”运行一次，收集完整日志。
- 根据日志逐条对照你列的 6 项检查点，若发现任何一项不一致，继续调整实现直到 6 项全部满足。