## 目标
- 基于 [chips.py](file:///Users/huangchuanjian/workspace/my_projects/ai_watch_stock/backend/utils/chips.py) 的筹码集中度代理指标，对全市场 A 股做过滤：在“今日或最近一个交易日”出现“相对自身历史的突然变得更集中（指标显著下跳）”。

## 数据与股票池
- 股票池：复用 [stock_codes.py](file:///Users/huangchuanjian/workspace/my_projects/ai_watch_stock/backend/utils/stock_codes.py) 的 `get_all_a_share_codes()`（带按天 CSV 缓存），得到 (market, code, name)。
- 交易日：用 Tushare `pro.trade_cal`（按规则显式使用 `pro`）获取最近开市日，避免周末/节假日误判；若 Tushare 不可用则降级为“今日若非交易日则回退到最近工作日”的简化逻辑。

## 指标计算（每只股票）
- 拉取区间：最近 `lookback_days`（默认 180~220）个自然日覆盖，确保能计算 `window=60` 和阈值统计 `N=120` 的历史。
- 调用：`get_chip_concentration_proxy(code, start_date, end_date, params=ChipProxyParams(window=60, smooth=5), as_df=True)`。
- 选用序列：以 `proxy_70_concentration_smooth` 作为主序列（更稳健），并保留原始值做展示。

## “忽然集中（拐点）”判定（自适应阈值）
对每只股票在最近交易日 t：
- 设 `x_t = proxy_70_concentration_smooth[t]`，`x_{t-1}` 为上个交易日。
1) **水平门槛（低分位）**：在过去 N=120 日（不含 t）上计算 `q10`，要求 `x_t <= q10`。
2) **跳变门槛（突然下跳）**：`delta = (x_t - x_{t-1}) / x_{t-1}`；在过去 N 日的 delta_hist 上取 `q05_delta`，要求 `delta <= min(q05_delta, -0.12)`。
3) **显著性门槛（鲁棒 z）**：对过去 N 日 `x` 计算中位数 m 与 MAD，`z = (x_t-m)/(1.4826*MAD)`（MAD=0 时改用 std），要求 `z <= -2.0`。
- 三条同时满足才入选，避免不同形态股票用固定阈值导致误报/漏报。

## 性能与稳定性
- 由于全市场逐只拉取 pytdx 日线较慢：
  - 使用小规模线程池并发（例如 6~10 workers），并对失败重试/切换 endpoint（chips.py 已内置 endpoint 选择与重试）。
  - 对异常、数据不足（有效样本 < max(10, window/3)）的股票直接跳过。
  - 控制输出行数：默认只保留评分最高的前 200~300 条，避免结果过大。

## 结果输出（写入 scripts/筹码忽然集中.py）
- 脚本顶层 try/except，按项目“选股脚本输出规范”产出 `df = pd.DataFrame(rows)`。
- 每行字段：`symbol`、`name`、`score`（由 z 与 delta 组合）、`reason`（短句）、以及 `date`、`x_t`、`x_{t-1}`、`delta`、`percentile`、`z` 等用于复核的关键列。

## 验证
- 本地运行脚本，确认：
  - 能正常拿到股票池与交易日；
  - 至少输出若干行结果（或在无结果时给出清晰日志）；
  - 结果列完整且数量受控。
