## 目标
- 在 `backend/scripts/赚钱的策略/` 里新增一个可直接运行的策略脚本：低持有周期、低回撤、高胜率、较高盈利（用可调参数在约束间取“均衡点”）。
- 数据源只用项目既有：pytdx + tushare（遵守现有 client 约定，不新增数据源、不写入真实 DB）。

## 策略定义（可解释且可回测）
### 核心思路：顺势回踩短持（偏高胜率）
- 顺势：用均线结构过滤（减少逆势亏损与回撤）。
- 回踩：在强趋势里等“轻回撤/缩量”入场（提高胜率与盈亏比稳定性）。
- 短持：最多持有 1-4 天，配合止盈/止损/移动止损/破位退出（控制回撤）。

### 信号（T 日收盘形成，T+1 日开盘入场）
1) 趋势过滤（T 日）
- `close_T > ma_fast_T > ma_slow_T`
- `ma_fast_T > ma_fast_{T-1}`（可选，避免下行趋势假信号）
2) 回踩幅度（T 日）
- `pullback = low_T / ma_fast_T - 1`
- 约束：`pullback_min <= pullback <= pullback_max`（默认倾向轻回撤：[-3%, +1%]）
3) 缩量（T 日）
- `vol_T <= ma_vol_{T-1} * vol_contract_ratio`（默认 0.75~1.0 之间，越严格胜率越高但机会更少）
4) 次日跳空限制（T+1 开盘）
- `open_{T+1} / close_T - 1 <= max_gap_up_pct`（避免追高导致回撤/止损）
5) 可选增强过滤（若 tushare pro 可用）
- `daily_basic.turnover_rate`、`daily_basic.volume_ratio`
- `moneyflow.net_mf_amount`
- 用于筛掉流动性差、承接弱、资金流出环境的信号（提高胜率/降低回撤）。

### 出场（入场后从入场日至 last_idx 逐日模拟）
- 止盈：`take_profit_pct`（默认 1%~2.5% 区间探索）
- 固定止损：`stop_loss_pct`（默认 1%~3% 区间探索）
- 移动止损：`trail_stop_pct`（用入场后最高价回撤计算）
- 保本线：`breakeven_after_pct`（上涨达到阈值后，把止损抬到成本）
- 破均线出场：`close_k < ma_fast_k`（避免拖成回撤）
- 时间退出：`max_hold_days`（默认 2~4 天区间探索）
- 涨跌停约束（若 tushare pro 可用且取到 `stk_limit`）：对当日 `open/high/low/close` 做夹逼，模拟“涨跌停无法成交/无法止损”的现实摩擦。

## 数据与字段（落地到代码里会严格按项目约定写）
### pytdx（日线）
- 使用 `tdx.get_security_bars(category=9, market, code, start, count)` 分页向前拼接；并将 `vol` 乘以 100 统一成“股”（与项目现有脚本一致）。
- 参考字段含义与单位：`datetime/open/close/high/low/vol/amount`（见 `docs/pytdx接口文档.md`）。
### tushare（增强特征，可选）
- `pro.daily_basic(fields=ts_code,trade_date,turnover_rate,volume_ratio)`
- `pro.moneyflow(fields=ts_code,trade_date,net_mf_amount)`
- `pro.stk_limit(fields=ts_code,trade_date,up_limit,down_limit)`
- 拉取结果以 `datetime(=trade_date)` 合并回日线。

## 产出脚本形态（一个脚本，多模式）
在执行阶段创建目录：`backend/scripts/赚钱的策略/`（当前仓库里不存在该目录）。

新增脚本（单文件即可跑通全流程）：
- `backend/scripts/赚钱的策略/均衡短持策略.py`

### CLI 设计（默认值偏“均衡”）
- `--mode`: `backtest` | `optimize` | `scan`
- `--start-year/--end-year`: 回测年份区间
- `--max-stocks`: 股票池截断（先小规模跑通）
- `--cache-dir`: 日线缓存目录（默认脚本目录下 `_cache_daily`，沿用现有脚本习惯）
- `--refresh-cache/--fetch-sleep`: 控制 pytdx 拉取与限频
- `--use-tushare-features/--ts-refresh-cache/--ts-fetch-sleep`: 控制 tushare 增强与缓存
- 参数（可直接手工指定覆盖默认）：
  - `--pullback-min/--pullback-max`
  - `--vol-contract-ratio`
  - `--take-profit-pct/--stop-loss-pct/--trail-stop-pct/--breakeven-after-pct`
  - `--exit-on-ma-fast-break`
  - `--max-hold-days/--max-gap-up-pct`
  - tushare 过滤：`--turnover-min/--turnover-max/--vr-min/--netmf-min/--netmf-ratio-min`
- 成本模型：
  - `--buy-fee-bps/--sell-fee-bps`（把滑点/佣金/印花税统一抽象成 bps）

## 参数寻优（optimize 模式：用“均衡评分”自动找参数）
### 搜索空间（默认收敛式两阶段）
- 粗网格：在合理离散集合上做笛卡尔积（规模可控）
- 细化：围绕上一轮 top1 的参数做邻域搜索（更快收敛）

### 评分函数（多目标折中）
输出每组参数的指标：
- `win_rate`、`profit_factor`、`avg_ret`、`avg_ret_per_day`
- `avg_hold_days`
- 风险侧：`min_ret`、`avg_loss_ret`
- 新增更贴近“回撤”的度量（落地实现）：
  - `mae_pct`：单笔交易期内的最大不利波动（用日内 low 相对入场价计算；考虑涨跌停夹逼后再算）
  - `worst_mae_pct` / `avg_mae_pct`
评分建议（在代码里可直接调权重）：
- 加分：`win_rate`、`profit_factor`、`avg_ret_per_day`
- 扣分：`abs(min_ret)`、`abs(avg_loss_ret)`、`worst_mae_pct`、`avg_hold_days`
- 并加上最小交易数约束，避免样本太小的“虚高参数”

## scan 模式（产出“可执行候选池”）
- 用最新可得的日线（缓存 + 可选刷新）计算指标，对最后一个交易日判断是否形成信号。
- 输出 CSV（utf-8-sig）到脚本目录（文件名带时间戳），包含：
  - `symbol/name/market`
  - `signal_date`
  - `score`（可用信号强度：趋势斜率/回踩幅度接近理想区间/缩量程度/资金流等组合）
  - `reason`（短句，便于你肉眼验）
  - 关键列：`close/ma_fast/ma_slow/pullback/vol_ratio/turnover_rate/volume_ratio/net_mf_amount`

## 执行阶段的具体实现步骤（逐步落地，不做大改）
1) 新建目录 `backend/scripts/赚钱的策略/`。
2) 基于现有脚本的稳定模式拷贝骨架：
   - `sys.path` 向上探测 `utils/pytdx_client.py`，确保从任意 cwd 可运行
   - `from utils.pytdx_client import tdx, connected_endpoint`
   - `try: from utils.tushare_client import pro except: pro=None`
3) 实现数据层：
   - `iter_all_a_share_defs()`：用 pytdx 拉全市场代码并过滤 A 股代码段
   - `load_or_fetch_daily()`：pytdx 日线分页拉取 + gzip 缓存（沿用现有 `daily_{market}_{code}.csv.gz` 命名）
   - `load_or_fetch_tushare_features()`：拉 `daily_basic/moneyflow/stk_limit` 合并成 `tsfeat_{market}_{code}.csv.gz`
4) 实现指标层：
   - MA（fast/slow/long）+ 成交量 MA
   - 回踩幅度/缩量比等派生字段
5) 实现回测引擎：
   - 严格按“信号日收盘形成，次日开盘进”的时序
   - 逐日出场规则（止盈/止损/移动止损/保本/破均线/时间退出）
   - 若有 `up_limit/down_limit`，对 OHLC 做夹逼后再进行撮合判断
   - 计算交易级指标与新增的 MAE 指标
6) 实现 optimize：
   - 粗网格 + 细化网格
   - 约束：`min_trades/target_win_rate/min_profit_factor/max_abs_min_ret/max_abs_avg_loss_ret/max_worst_mae`（默认给“均衡”门槛）
   - 输出：`*_topk.csv`（每轮 topk）与 `*_best_trades.csv`（最优参数的交易明细）
7) 实现 scan：
   - 读取参数（优先命令行；可选支持从上一次 `*_topk.csv` 读取 top1 参数）
   - 输出今日候选 `*_candidates.csv`
8) 校验（不重启任何服务）：
   - 先用 `--max-stocks 50 --mode backtest --start-year 2023 --end-year 2024` 跑通闭环
   - 再用 `--mode optimize --max-iters 1` 验证输出文件与指标合理
   - 最后跑 `--mode scan --max-stocks 200` 检查候选集规模与字段完整性

