# 北方华创 (002371) 监控流程全链路测试计划

## 1. 测试目标
复现并诊断“北方华创”在监控过程中出现的 **AI 返回非 JSON 格式导致解析失败** 的问题，验证数据链路、Prompt 构建及 AI 响应的稳定性。

## 2. 测试方案
创建一个独立的复现脚本 `tests/reproduce_002371_flow.py`，模拟 `monitor_service.py` 的核心逻辑，但剥离数据库写入操作以保证安全。

## 3. 执行步骤
### 步骤一：环境与配置加载
- 从 `backend/stock_watch.db` 读取“北方华创” (ID: 4) 的完整配置（监控模式、Prompt 模板）。
- 读取关联的 AI 配置 (Gemini, `localhost:8001`)。

### 步骤二：数据获取 (Mock/Replay)
- **策略**：为了精准复现报错现场，不进行新的网络请求，而是直接加载 **日志 ID 108** 中的 `raw_data`（约 25万字符）。
- **目的**：确保测试用的数据上下文与生产环境中报错时完全一致，排除实时数据波动的影响。

### 步骤三：Prompt 构建与诊断
- 调用 `ai_service` 的 Prompt 构建逻辑，生成最终发送给 AI 的 System Prompt 和 User Prompt。
- **检查点**：
  - 打印 System Prompt 中是否存在导致模型困惑的注释（如 `// info=...`）。
  - 统计 User Prompt 的字符数与 Token 数，评估是否接近 HTTP 传输极限。

### 步骤四：AI 调用与响应分析
- 使用 `openai` SDK 向 `http://localhost:8001/v1` 发送请求（复用生产参数 `response_format={"type": "json_object"}`）。
- **关键动作**：
  - 捕获 AI 返回的 **原始文本 (Raw Content)**。
  - 尝试使用现有的 `json.loads` 逻辑解析。
  - 如果解析失败，打印完整的原始文本以定位原因（是纯文本报错、Markdown 包裹、还是格式错误）。

## 4. 预期产出 (问题诊断报告)
脚本运行后，我将为您提供一份报告，包含：
1. **Prompt 诊断**：System Prompt 是否包含诱导错误的写法。
2. **负载分析**：请求体大小是否过大。
3. **根因定位**：明确 Gemini 返回“无法解析响应”的具体触发条件。
4. **修复建议**：针对性的代码修改方案（如清洗 System Prompt、增加解析容错、或精简输入数据）。