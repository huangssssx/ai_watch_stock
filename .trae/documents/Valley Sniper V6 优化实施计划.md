# Valley Sniper V6: 深度研发与回测闭环计划

收到指令。我们将采用**“研发-回测-迭代”**的闭环模式，以数据说话，确保 V6 版本在胜率和盈亏比上确实超越 V5（原版），而非仅仅是理论上的优化。

## 第一阶段：基准测试 (Baseline Benchmark)
1.  **复现原版性能**：运行当前的 `山谷狙击选股策略_optimized.py` (V5)，在指定的回测区间（如过去 1 年）进行模拟选股。
2.  **记录指标**：统计选出股票的 **次日涨幅**、**3日涨幅**、**5日最大回撤**、**胜率** (3日涨幅>2%)。这将作为我们优化的基准线 (Baseline)。

## 第二阶段：增量优化与验证 (Iterative Optimization)
我们将逐一引入优化因子，并验证其对胜率的贡献：

### Round 1: 风控因子引入
*   **动作**：加入 `Price > MA20` (均线防守) 和 `Gap Filter` (缺口过滤)。
*   **验证**：运行回测。
*   **目标**：胜率提升，最大回撤显著降低。

### Round 2: 评分算法重构
*   **动作**：将线性归一化改为 `Rank-based` (分位数) 评分。
*   **验证**：对比高分股票的分布是否更合理，是否过滤掉了被妖股“平均”掉的优质股。

### Round 3: MACD 与 趋势确认
*   **动作**：引入 MACD 金叉/水上条件。
*   **验证**：检查这是否过滤掉了太多“左侧抄底”的机会？寻找“胜率”与“信号数量”的最佳平衡点。

## 第三阶段：全市场回测系统构建
为了实现上述迭代，我需要构建一个专门的**选股策略回测框架**（区别于之前的单股监控回测）：
*   **脚本**：`backend/scripts/backtest_screener_v6.py`
*   **功能**：
    1.  拉取全市场历史快照（模拟某一日的选股环境）。
    2.  运行策略逻辑，输出选股列表。
    3.  跟踪选出股票在随后 N 天的表现。
    4.  输出统计报告。

## 第四阶段：最终交付 (Final Delivery)
只有当 V6 版本的**胜率**和**盈亏比**在回测中明确优于 V5 时，我才会：
1.  生成最终的 `山谷狙击选股策略_optimized_v6.py`。
2.  更新数据库 (`stock_screeners` 表)。
3.  提交详细的对比测试报告。

---

**预计工作量较大**，特别是全市场回测涉及大量数据处理。我将优先构建回测框架。

**请确认启动此“研发-回测-优化”闭环流程？**