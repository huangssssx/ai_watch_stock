# 回测系统 V5.0：完整交易闭环 (The Closed Loop)

您的建议如当头棒喝，补上了系统中最关键的最后两块拼图：**流动性风控**与**离场纪律**。

一个没有明确卖出规则的回测只是数字游戏，而忽视涨停板限制的回测则是自欺欺人。我完全接受您的建议，将 **V5.0 方案** 定义为包含完整生命周期的交易系统。

## 一、 严苛的入场风控 (The Gatekeeper)

在 Layer 2（10:00 确认）阶段，除了原有的“量能+价格”校验外，新增**“涨停回避”**熔断机制：

*   **新增规则**：如果 `Price_10:00 >= PrevClose * 1.09`（涨幅超过 9%），**强制放弃买入**。
*   **逻辑**：
    1.  **买不进**：实盘中可能已经封板，排队也买不到。
    2.  **盈亏比差**：即便买进去了，当天上涨空间仅剩 1%，而炸板风险却很大。我们只做“鱼身”，拒绝“接飞刀”。

## 二、 铁血的离场规则 (The Exit Standard)

为了验证策略最核心的 **“隔夜溢价” (Overnight Premium)** 能力，我们将卖出规则标准化：

*   **卖出价格**：严格按 **T+1 日开盘价 (Open)** 结算。
*   **逻辑**：
    *   如果策略有效，它选出的热点应该能维持到次日开盘（高开）。
    *   如果 T+1 直接低开，说明选出的是“一日游”骗线，策略失败。
    *   *这是对策略最保守、最严酷的考验。*

## 三、 净收益公式 (Net Profit Calculation)

每一笔交易的收益率将按以下公式计算，计入所有滑点和摩擦成本：

$$ \text{Net Return} = \frac{\text{Open}_{T+1} - (\text{Close}_{10:00} \times 1.01)}{\text{Close}_{10:00} \times 1.01} $$

*   **入场滑点**：1%（模拟追高成本）。
*   **离场滑点**：0%（假设集合竞价成交）。
*   **印花税/佣金**：暂忽略（已被入场滑点覆盖）。

---

## 四、 执行蓝图 (Blueprint)

我将立即着手编写 `backtest_v5.py`，核心流程如下：

1.  **T-1 晚间**：全市场扫描，选出 `RPP < 0.4` 且 `MA` 多头的 **Watchlist**。
2.  **T日 10:00**：
    *   拉取 Watchlist 分钟数据。
    *   过滤掉 `涨幅 > 9%` 的票。
    *   买入满足 `Vol > 20%` & `Price > VWAP` 的票。
3.  **T+1 早盘**：按 `Open` 卖出，记录盈亏。
4.  **循环迭代**：跑完 60 天数据，统计总胜率和夏普比率。

**这是最终的作战计划。如果没有任何异议，我将开始构建这个回测引擎。**
