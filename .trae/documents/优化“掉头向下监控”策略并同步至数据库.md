# 优化“掉头向下监控”策略并同步至数据库

根据 `问题.md` 中的深度研究报告，目前的 v3.1 脚本虽然已经引入了 KAMA 自适应均线，但缺少关键的 **市场体制识别（Market Regime Detection）** 模块。本计划将引入 **Choppiness Index (CHOP)** 指标，通过识别“震荡体制”来过滤 MA20 的假突破信号，从而降低误报率。

## 1. 策略代码优化 (本地开发)
### 核心改进：引入“震荡过滤器”
- **新增指标**：实现 `calculate_chop(df, window=14)` 函数，计算市场的“无序度”。
- **逻辑升级**：
    - **震荡识别**：当 `CHOP > 61.8` 时，判定市场为“高波动震荡体制”。
    - **信号过滤**：在震荡体制下，屏蔽普通的“跌破 KAMA 快线”或“跌破 MA20”信号，除非伴随极端的放量或周线级别的共振（即提高触发门槛）。
    - **趋势确认**：当 `CHOP < 38.2` 时，判定为“趋势体制”，允许灵敏度较高的信号触发。

## 2. 回测与验证 (本地测试)
### 验证方案
- **升级回测引擎**：修改 `sandbox_downturn_backtest.py`，支持“新旧策略对比”模式。
- **测试标的**：
    - **震荡样本**：选取近期长期横盘的个股（如部分银行股或周期底部股），验证是否减少了“频繁止损”。
    - **趋势样本**：选取近期大跌的个股（如高位崩盘股），验证是否依然能及时预警。
- **通过标准**：新策略在震荡市中的**误报率（False Alarms）降低 30% 以上**，且在趋势反转时的**滞后天数增加不超过 1 天**。

## 3. 数据库同步 (生产部署)
### 安全更新流程
- **效果确认**：一旦回测数据达标，将最终定稿的脚本保存。
- **执行更新**：运行 `backend/scripts/insert_downturn_rule.py --force`，将本地优化后的脚本写入数据库 `rule_scripts` 表。
- **最终校验**：从数据库读取脚本并进行哈希比对，确保更新无误。
