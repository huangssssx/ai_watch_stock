# 项目规则（ai_watch_stock）
- 请使用中文和我交流数据单位相关问题，谢谢！

## DB 安全（保持不变）
- 默认只使用已有的 `backend/stock_watch.db`，禁止隐式新建任何 `.db` 文件
- 任何对 SQLite 的连接/写入前，必须先检查目标 DB 文件已存在；不存在则中止并提示
- 禁止在真实 DB 上运行会执行 `drop_all/create_all` 的测试或脚本
- 如需测试数据库，必须使用独立测试库文件（例如 `stock_watch_test.db`）并与真实库隔离
- 如确需新建/切换 DB 文件，必须提前告知用户原因、路径与影响范围

## 数据来源（适配 Tushare）
- 所有股票数据均来自 [Tushare](https://tushare.pro/)，禁止直接从其他来源获取
- 如需新增数据来源，必须先与项目负责人确认并获得授权
- 所有数据获取均需在遵守相关法律法规的前提下进行，同时严格遵守 Tushare 的 API 使用规范（包括但不限于调用频率限制、token 有效期、数据使用范围等）
- 使用 Tushare 前必须确保已配置有效的 token，且 token 的权限等级满足目标数据的获取需求；token 需妥善保管，禁止硬编码在代码中（建议通过环境变量/配置文件加载）
- 禁止绕过 Tushare 官方 SDK 进行非授权的数据抓取或接口调用

## Tushare 数据单位规范 (Hand vs. Share)
- **警惕单位陷阱**：Tushare 不同接口返回的成交量单位存在差异（例如 `pro.daily` 返回的 `vol` 为“手”，`amount` 为“千元”；而实时接口 `get_realtime_quotes` 返回的 `volume` 为“股”，`amount` 为“元”）。
- **必须校验**：在使用 `成交量` 或 `成交额` 进行计算（如 VWAP、换手率）前，**必须**进行数量级校验。
- **自适应逻辑**：
  - 计算 `Raw_VWAP = Amount / Volume`。
  - 基准参考：获取该股票的最新成交价（price）。
  - 判定规则：
    - 如果 `Raw_VWAP` 约为当前股价的 **0.1 倍** (0.08-0.12)：说明 Volume 单位为“手”，Amount 单位为“千元”（常见于 `pro.daily`）。
    - 如果 `Raw_VWAP` 约为当前股价的 **100 倍** (80-120)：说明 Volume 单位为“手”，Amount 单位为“元”。
    - 如果 `Raw_VWAP` 与当前股价接近 (0.8-1.2)：说明 Volume 单位为“股”，Amount 单位为“元”（常见于实时接口）。
- **禁止假设**：必须在代码中实现上述自适应防御逻辑，防止单位错误导致计算严重偏差（如 VWAP 虚高或虚低）。
- 常用接口对照表：`docs/tushare_units.md`