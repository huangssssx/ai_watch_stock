# 股票扫描脚本输出0结果 - 问题诊断报告

## 问题现象

原脚本输出结果为0，没有筛选出任何股票。

## 根本原因

### 1. 时间问题
- **运行时间**: 09:21（A股开盘前）
- **开盘时间**: 09:30
- **结果**: 还未到交易时间

### 2. 数据字段状态

在开盘前（09:21），akshare 返回的数据状态：

| 字段 | 状态 | 说明 |
|------|------|------|
| 最新价 | ✅ 有数据 | 昨日收盘价或竞价价格 |
| 今开 | ✅ 有数据 | 集合竞价结果 |
| 最高/最低 | ✅ 有数据 | 竞价产生的价格 |
| **成交量** | ❌ 全部 NaN | 未开始交易 |
| **成交额** | ❌ 全部 NaN | 未开始交易 |
| **换手率** | ❌ 全部 0.0 | 因为无成交量 |

### 3. 过滤逻辑问题

原脚本的过滤条件：
```python
df_spot = df_spot[df_spot['成交额'] > 100000000]  # 成交额 > 1亿
target_stocks = df_spot.sort_values(by='换手率', ascending=False).head(100)
```

**问题**：
- `成交额` 全部为 NaN，不满足 `> 1亿` 条件
- 所有股票都被过滤掉
- `target_stocks` 为空

## 解决方案

### 方案1：智能时段筛选（推荐）

根据不同时段使用不同筛选条件：

```python
# 判断交易时段
is_trading_time = (9 <= now.hour < 15) and not (now.hour == 12)

if is_trading_time:
    # 交易时段：优先使用成交额/换手率
    if df_spot['成交额'].notna().any():
        df_spot = df_spot[df_spot['成交额'] > 50000000]  # >5000万
    elif (df_spot['换手率'] > 0).any():
        df_spot = df_spot[df_spot['换手率'] > 3]  # 换手率>3%
    else:
        # 盘前刚开盘，用涨跌幅
        df_spot = df_spot[df_spot['涨跌幅'] > 3]  # 涨幅>3%
else:
    # 非交易时段：用涨跌幅
    df_spot = df_spot[df_spot['涨跌幅'] > 2]
```

### 方案2：降低阈值

```python
# 降低成交额阈值
df_spot = df_spot[df_spot['成交额'] > 10000000]  # 改为1000万
```

### 方案3：使用多种筛选条件

```python
# 使用 OR 逻辑
mask = (
    (df_spot['成交额'] > 100000000) |  # 成交额达标
    (df_spot['换手率'] > 5) |  # 或换手率达标
    (df_spot['涨跌幅'] > 5)  # 或涨幅达标
)
df_spot = df_spot[mask]
```

### 方案4：分时运行策略

- **09:15-09:30**: 使用涨跌幅筛选
- **09:30-11:30**: 使用成交额/换手率筛选
- **13:00-15:00**: 使用成交额/换手率筛选
- **其他时间**: 使用历史数据

## 修复版脚本特点

1. **智能时段判断**: 自动识别交易/非交易时段
2. **容错机制**: 当某个字段无数据时，自动切换到其他字段
3. **降低阈值**: 盘前使用更宽松的筛选条件
4. **详细日志**: 输出当前使用的筛选策略

## 最佳实践

### 运行时间建议
- **盘前筛选**: 09:20-09:25（集合竞价结束后）
- **盘中筛选**: 09:30-15:00（交易时段）
- **复盘筛选**: 15:00-18:00（收盘后）

### 调试建议
1. 先运行 `check_data.py` 检查数据状态
2. 查看各字段是否有数据
3. 根据实际情况选择筛选条件

### 性能优化
- 限制扫描股票数量（如 Top 100）
- 使用并发请求（注意频率限制）
- 缓存历史数据，避免重复请求

## 测试脚本

已创建以下调试脚本：

1. `check_data.py` - 检查数据字段状态
2. `check_turnover.py` - 检查换手率数据
3. `debug_stock_scan.py` - 带详细日志的调试版
4. `全天候策略修复版.py` - 修复后的生产版本

## 总结

**核心问题**: 在开盘前（09:21），成交额、成交量、换手率均为空/零，导致所有股票被过滤。

**解决方案**: 使用智能时段筛选，根据不同时段和数据可用性动态调整筛选条件。

**推荐做法**: 等到 09:30 之后再运行，使用成交额/换手率筛选，效果最佳。
