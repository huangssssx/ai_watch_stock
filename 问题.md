# -----------------------------------------------------------------------------
# 脚本名称：万向钱潮-早盘狙击特化版 (一次性使用)
# 核心策略：时间窗狙击 + 弱转强博弈
# 运行建议：仅在周一上午 09:25 - 10:30 开启任务，触发一次后即可手动停止任务。
# -----------------------------------------------------------------------------

triggered = False
signal = "WAIT"
message = "狙击镜校准中..."

try:
    # 1. 【时间锁】严格的时间窗口控制
    # 逻辑：9:40前不看（避开假动作），10:15后不追（防止冲高回落）
    now_time = datetime.datetime.now().time()
    start_window = datetime.time(9, 40)
    end_window = datetime.time(10, 15)
    
    if now_time < start_window:
        message = f"未到狙击时间：当前{now_time.strftime('%H:%M')}，静待09:40市场分歧释放"
    elif now_time > end_window:
        message = "窗口期已过：10:15后不再开新仓，避免高位站岗"
    else:
        # 2. 【数据源】获取实时行情
        symbol_code = symbol
        if symbol.startswith(("sh", "sz", "bj")):
            symbol_code = symbol[2:]
            
        # 获取最近两日数据（昨日收盘 + 今日实时）
        df = ak.stock_zh_a_hist(symbol=symbol_code, period="daily", start_date="20250101", adjust="qfq")
        
        if df is None or len(df) < 2:
            message = "数据不足，无法计算"
        else:
            today_row = df.iloc[-1]
            yesterday_row = df.iloc[-2]
            
            # 关键价格点位
            last_close = yesterday_row['收盘']  # 昨收（基准线）
            open_price = today_row['开盘']      # 今开
            current_price = today_row['收盘']   # 现价（akshare即时数据中收盘即现价）
            low_price = today_row['最低']       # 今日最低
            
            # 计算涨幅
            pct_chg = (current_price - last_close) / last_close * 100
            
            # 3. 【狙击判定】三大核心条件
            
            # 条件A：拒绝高开诱多
            # 如果开盘就涨超 4%，直接放弃，肉少风险大
            is_safe_open = open_price < (last_close * 1.04)
            
            # 条件B：必须有“下杀”动作（恐慌盘已出）
            # 今日最低价必须低于开盘价至少 0.5%，说明有人砸过盘了
            has_dip = low_price < (open_price * 0.995)
            
            # 条件C：弱转强（关键信号）
            # 现价已经拉回并在开盘价之上，且涨幅为正（翻红）
            is_reversal = (current_price > open_price) and (current_price > last_close)
            
            # 条件D：涨幅控制（只吃鱼身）
            # 涨幅在 0% ~ 5% 之间是最佳买点，超过 6% 就不追了
            is_good_range = 0.0 < pct_chg < 6.0
            
            # --- 最终判定 ---
            if is_safe_open and has_dip and is_reversal and is_good_range:
                triggered = True
                signal = "BUY" # 或者 "STRONG_BUY"
                message = f"【狙击命中】V型反转！曾跌至{low_price}，现价{current_price}(+{pct_chg:.2f}%)翻红，恐慌盘已清洗"
            
            # 特殊情况：如果在这个时间点跌破了昨收盘且跌幅扩大，提示风险
            elif current_price < last_close and pct_chg < -2.0:
                triggered = True
                signal = "WAIT" # 明确的观望信号
                message = f"【放弃信号】持续走弱，跌幅{pct_chg:.2f}%，未出现承接"
            
            else:
                triggered = False
                message = f"监控中：{now_time.strftime('%H:%M')} | 现价{current_price} | 涨幅{pct_chg:.2f}% | 等待翻红信号"

except Exception as e:
    triggered = False
    message = f"错误：{str(e)}"